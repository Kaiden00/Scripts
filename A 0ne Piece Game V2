
if not game:IsLoaded() then game.Loaded:Wait() end

--//Services
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

--//Imports
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/wally-rblx/uwuware-ui/main/main.lua"))()
local MaidClass = loadstring(game:HttpGet("https://raw.githubusercontent.com/Quenty/NevermoreEngine/version2/Modules/Shared/Events/Maid.lua"))()
local SignalClass = loadstring(game:HttpGet("https://raw.githubusercontent.com/Quenty/NevermoreEngine/version2/Modules/Shared/Events/Signal.lua"))()

--//Variables
local Client = game:GetService("Players").LocalPlayer
local QuestFolder = Client:WaitForChild("Quests2")

local Window = Library:CreateWindow("A 0ne Piece Game")

local MainFolder = Window:AddFolder("Main")
local TeleportFolder = Window:AddFolder("Teleports")
local SettingsFolder = Window:AddFolder("Settings")
local CreditsFolder = Window:AddFolder("Credits")

local Entities = workspace.Entities
local MobList = {}

local Signals = {
    ["NameSignal"] = SignalClass.new()
}

local MainMaid = MaidClass.new()
local CharacterMaid = MaidClass.new()

local AbilityEvent = ReplicatedStorage.Remotes.requestAbility
local QuestEvent = ReplicatedStorage.Remotes.quest

local FakePart = Instance.new("Part")

local QuestModule = require(ReplicatedStorage.Modules.Shared.Database.Quests)

local LastAttack = 0

local MapFolder = workspace.Map
local InteractableFolder = workspace.Interactables
local IslandFolder = MapFolder.Islands

--//Functions
local function TweenTeleport(Position)
    local HumanoidRootPart = Client.Character:FindFirstChild("HumanoidRootPart")
    if not HumanoidRootPart or not Position then return end
    
    local Info = TweenInfo.new((Position - HumanoidRootPart.Position).Magnitude/Library.flags.TweenSpeed, Enum.EasingStyle.Linear)
    local Tween = TweenService:Create(HumanoidRootPart, Info, {CFrame = CFrame.new(Position.X, Position.Y + 5, Position.Z)})
    
    Tween:Play()
    Tween.Completed:Wait()
end

local function Attack(Position)
    if os.clock() - LastAttack < 0.2 then return end --need to do this shit since their combat is laggy as hell
    LastAttack = os.clock()
    AbilityEvent:FireServer("Fighting Style", "MouseButton1", CFrame.new(Position), FakePart, 5)
    AbilityEvent:FireServer("Sword Style", "MouseButton1", CFrame.new(Position), FakePart, 5)
end

local function GetQuest()
    local MobName = Library.flags.TargetMob
    local Folder = QuestFolder:FindFirstChildWhichIsA("Folder")

    if Folder then 
        if Folder.Target.Value == MobName then
            return 
        end
        QuestEvent:FireServer("Abandon", {Id = "1"})
    end
    
    for Dummy, Data in pairs(QuestModule) do
        if type(Data) ~= "table" then continue end
        for I, Data2 in pairs(Data) do
            if Data2.Target ~= MobName then continue end
            Client.Character.HumanoidRootPart.CFrame = Dummy.CFrame
            QuestEvent:FireServer("Accept", {Index = I, Model = Dummy})
            break
        end 
    end
end

local function IsAlive(Character)
    if not Character or not Character.Parent then return end
    local Humanoid = Character:FindFirstChildWhichIsA("Humanoid")

    if not Humanoid or not Character:FindFirstChild("HumanoidRootPart") then return end
    if Humanoid.Health <= 0 then return end

    return true
end

local function OnMobAdded(Mob)
    local Index = table.find(MobList, Mob)
    if Index then return end

    if Players:GetPlayerFromCharacter(Mob) then return end
    if not IsAlive(Mob) then return end
    
    MobList[#MobList + 1] = Mob

    MainMaid:GiveTask(Mob.AncestryChanged:Connect(function(_, Parent)
        if not Parent or not Mob:IsDescendantOf(Entities) then 
            table.remove(MobList, Index)
        end 
    end))
end

local function OnChestAdded(Chest)
    if not Library.flags.ChestFarm then return end
    if Library.flags.Autofarm then return end

    local ClickDetectorPart = Chest:FindFirstChild("ClickDetectorPart")
    if not ClickDetectorPart then return end

    local ClickDetector = ClickDetectorPart:FindFirstChildWhichIsA("ClickDetector")
    if not ClickDetector then return end

    repeat task.wait() 
        Client.Character.HumanoidRootPart.CFrame = ClickDetectorPart.CFrame
        fireclickdetector(ClickDetector)
    until not ClickDetector:IsDescendantOf(workspace) or not IsAlive(Client.Character) or not Library.flags.ChestFarm or Library.flags.Autofarm
end

local function GetMob()
    for Index = 1, #MobList do 
        local Mob = MobList[Index]
        if not Library.flags.Autofarm then break end
        if string.lower(Mob.Name) ~= string.lower(Library.flags.TargetMob) then continue end
        if not IsAlive(Mob) then continue end

        return Mob
    end 
end

local function OnCharacterAdded(Character)
    CharacterMaid:DoCleaning()

    local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
    local Humanoid = Character:WaitForChild("Humanoid")
    local CurrentMob = nil

    CharacterMaid:GiveTask(RunService.Heartbeat:Connect(function()
        if not Library.flags.Autofarm then return end
        if not IsAlive(Character) then return end
        if not IsAlive(CurrentMob) or CurrentMob.Name ~= Library.flags.TargetMob then
            CurrentMob = GetMob()
            return
        end
        
        if Library.flags.AutoQuest then
            GetQuest()
            if not QuestFolder:FindFirstChildWhichIsA("Folder") then return end
        end

        local Rotation = 90
        if Library.flags.FarmDistance > 0 then 
            Rotation = -90
        end

        HumanoidRootPart.CFrame = CurrentMob.HumanoidRootPart.CFrame * CFrame.new(0,Library.flags.FarmDistance,0) * CFrame.Angles(math.rad(Rotation),0,0)
        Attack(CurrentMob.HumanoidRootPart.Position)
    end))
    
    CharacterMaid:GiveTask(Signals["NameSignal"]:Connect(function()
        if not Library.flags.Namehide then return end
        local NameTag = HumanoidRootPart:WaitForChild("OverheadUI", 3)
        if not NameTag then return end
        NameTag:Destroy()
    end))

    CharacterMaid:GiveTask(IslandFolder.DescendantAdded:Connect(function(Chest)
        task.wait(0.05)
        OnChestAdded(Chest)
    end))

    Signals["NameSignal"]:Fire()
    for _, Chest in ipairs(IslandFolder:GetDescendants()) do
        OnChestAdded(Chest)
    end
end

--//Init
if getgenv().UnloadScript then
    pcall(getgenv().UnloadScript)
end

getgenv().UnloadScript = function()
    MainMaid:Destroy()
    CharacterMaid:Destroy()
    MainMaid = nil
    CharacterMaid = nil

    if Library.open then
        Library:Close()
    end
    
    Library.base:ClearAllChildren()
    Library.base:Destroy()
end 

MainMaid:GiveTask(Client.CharacterAdded:Connect(OnCharacterAdded))
if Client.Character then
    task.spawn(OnCharacterAdded, Client.Character)
end 

MainMaid:GiveTask(Entities.ChildAdded:Connect(function(Mob)
    task.wait(0.05)
    OnMobAdded(Mob)
end))

for _, Mob in ipairs(Entities:GetChildren()) do 
    task.spawn(OnMobAdded, Mob)
end

for _, Connection in pairs(getconnections(Client.Idled)) do --anti afk
    Connection:Disable()
end

--//Library
local MobNames = {}
local NPCList = {}

for _, NPC in ipairs(InteractableFolder:GetChildren()) do 
    if not NPC:FindFirstChild("HumanoidRootPart") then continue end
    NPCList[#NPCList + 1] = NPC.Name 
end 

for _, Object in ipairs(ReplicatedStorage:GetChildren()) do
    if table.find(MobNames, Object.Name) then continue end
    if not Object:FindFirstChild("Data") then continue end
    MobNames[#MobNames + 1] = Object.Name 
end

for _, Object in ipairs(Entities:GetChildren()) do
    if table.find(MobNames, Object.Name) then continue end
    if not Object:FindFirstChild("Data") then continue end
    MobNames[#MobNames + 1] = Object.Name
end

table.sort(MobNames, function(A, B)
    return A < B
end)

--Settings folder
SettingsFolder:AddSlider({text = "Farm Distance", flag = "FarmDistance", min = -10, max = 8})
SettingsFolder:AddSlider({text = "Tween Speed", flag = "TweenSpeed", min = 1000, max = 10000})

--Main folder
MainFolder:AddList({text = "Mob", flag = "TargetMob", values = MobNames})
MainFolder:AddToggle({text = "Auto Quest", flag = "AutoQuest"})
MainFolder:AddToggle({text = "Autofarm", flag = "Autofarm"})

MainFolder:AddToggle({text = "Fruit Farm[S^X]", callback = function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/Kaiden00/Scripts/main/A%200ne%20Piece%20Game"))()
    syn.queue_on_teleport([[
        loadstring(game:HttpGet("https://raw.githubusercontent.com/Kaiden00/Scripts/main/A%200ne%20Piece%20Game"))()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/Kaiden00/Scripts/main/A%200ne%20Piece%20Game%20V2"))() --re execute fruit farmer
    ]])
end})

MainFolder:AddToggle({text = "Chest Farm", flag = "ChestFarm", callback = function()
    for _, Chest in ipairs(IslandFolder:GetDescendants()) do
        OnChestAdded(Chest)
    end
end})

MainFolder:AddToggle({text = "Hide name", flag = "Namehide", callback = function()
    Signals["NameSignal"]:Fire()
end})

--Teleport folder
TeleportFolder:AddList({text = "Islands", values = IslandFolder:GetChildren(), callback = function(IslandName)
    local Part = IslandFolder[IslandName]:FindFirstChildWhichIsA("SpawnLocation", true) or IslandFolder[IslandName]:FindFirstChildWhichIsA("BasePart", true)
    pcall(TweenTeleport, Part.Position)
end})

TeleportFolder:AddList({text = "NPCs", values = NPCList, callback = function(NPCName)
    pcall(TweenTeleport, InteractableFolder[NPCName].HumanoidRootPart.Position)
end})

--Credits folder
CreditsFolder:AddLabel({text = "Script: Kaiden"})
CreditsFolder:AddLabel({text = "UI Library: Jan"})

Window:AddBind({text = "Menu toggle", key = Enum.KeyCode.End, callback = function() Library:Close() end})
Library:Init()

warn("Loaded!")
