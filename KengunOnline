
getgenv().TrainType = "Durability" --Options: Durability, Strength
getgenv().TweenSpeed = 75

game:GetService("GuiService").ErrorMessageChanged:Connect(function()
    while true do
        game:GetService("TeleportService"):Teleport(11637068797)
        task.wait(1)
    end
end)

if not game:IsLoaded() then
    game.Loaded:Wait()
end

if game.PlaceId ~= 11637068797 then
    return game:GetService("TeleportService"):Teleport(11637068797)
end

local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")

local DataFunction = game:GetService("ReplicatedStorage").Communication.Functions.ClientData
local QuestEvent = game:GetService("ReplicatedStorage").Communication.Events.QuestEvent

local Client = Players.LocalPlayer
local QuestNPCs = workspace.World.NPCs.Quests

local EquipmentFolder = game:GetService("Workspace").World.Map["Training Equipment"]
local Equipments = EquipmentFolder:GetChildren()

local RemoteManager = require(game.ReplicatedStorage["Modules"]["GlobalModules"]).RemoteManager
local BoxingGloves = workspace.World.Products["Boxing Gloves"]

local function Click(ClickDetector)
    local Mouse = Client:GetMouse()
    local Part = Instance.new("Part")
    local OldParent = ClickDetector.Parent
    
    Part.Anchored = true
    Part.CanCollide = false
    Part.Size = Vector3.new(100, 100, 1)
    Part.Transparency = 1
    Part.Parent = workspace
    
    ClickDetector.Parent = Part
    ClickDetector.MouseHoverEnter:Once(function()
        ClickDetector.Parent = OldParent
        Part:Destroy()
        task.wait()
        fireclickdetector(ClickDetector)
    end)
    
    Part.CFrame = Mouse.Hit
    ClickDetector.MouseHoverEnter:Wait()
end

local function OnCharacterAdded(Character, IsNew)
    local PrimaryPart = Character:WaitForChild("HumanoidRootPart")
    local Humanoid = Character:WaitForChild("Humanoid")
    
    local Equipment = TrainType == "Durability" and EquipmentFolder["WingChun"] or EquipmentFolder["PunchingBag"]
    
    if IsNew then
        return Humanoid:Destroy()
    end

    Character:GetPropertyChangedSignal("Parent"):Connect(function()
        if Character and Character.Parent and Character.Parent.Name ~= "DownedCharacters" then return end
        Humanoid:Destroy()
    end)
    
    local EquipmentCFrame = Equipment.HumanoidRootPart.CFrame
    EquipmentCFrame = TrainType == "Durability" and EquipmentCFrame or EquipmentCFrame * CFrame.Angles(0,math.rad(90),0)
    PrimaryPart.CFrame = EquipmentCFrame
    task.wait()
    
    task.spawn(function()
        while Humanoid and Humanoid.Parent do
            if TrainType == "Strength" then
                if not Character:FindFirstChild("BoxingGlovesModel") and not Client.Backpack:FindFirstChild("Boxing Gloves") and not Character:FindFirstChild("Boxing Gloves") then
                    repeat
                        if Client.Character:FindFirstChild("Combat") then
                            Client.Character.Combat.Parent = Client.Backpack
                        end 
                        local Info = TweenInfo.new((PrimaryPart.Position - BoxingGloves.Decor.Position).Magnitude / TweenSpeed)
                        local Tween = TweenService:Create(PrimaryPart, Info, {CFrame = BoxingGloves.Decor.CFrame})
                        Tween:Play()
                        Tween.Completed:Wait()
                        task.wait(0.25)
                        Click(BoxingGloves.ClickDetector)
                        task.wait(0.5)
                    until Client.Backpack:FindFirstChild("Boxing Gloves")
                end
                
                local Gloves = Client.Backpack:FindFirstChild("Boxing Gloves") or Character:FindFirstChild("Boxing Gloves")
                if Gloves then
                    Gloves.Parent = Character
                    Gloves:Activate()
                end
            end
            
            local Offset = TrainType == "Durability" and Vector3.new(5, 0, -3) or Vector3.new(5, 0, 3)

            pcall(function()
                Humanoid:EquipTool(Client.Backpack.Combat) 
            end)
            
            if Client:DistanceFromCharacter(Equipment.HumanoidRootPart.Position) > 10 then
                local Info = TweenInfo.new((PrimaryPart.Position - EquipmentCFrame.Position).Magnitude / TweenSpeed)
                local Tween = TweenService:Create(PrimaryPart, Info, {CFrame = EquipmentCFrame})
                Tween:Play()
                Tween.Completed:Wait()
            else
                PrimaryPart.CFrame = EquipmentCFrame + Offset
            end
            
            RemoteManager.FireConnection("CombatEvent", {
            	Side = "Client"
            }, "SoundEffects", {
            	AttackType = "Light", 
            	Info = 0.1
            })
        
            for _, Equipment in ipairs(Equipments) do
                if Client:DistanceFromCharacter(Equipment.HumanoidRootPart.Position) > 15 then continue end
                
                RemoteManager.FireConnection("CombatEvent", {Side = "Client"}, "RegisterHit", {
                	FoundPlayers = Equipment, 
                	Ticks = 1, 
                	AttackType = "Light", 
                	C = Equipment.HumanoidRootPart.CFrame
                })
            end
            
            task.wait(0.2)
        end 
    end)
end

if Client.Character then
    task.spawn(OnCharacterAdded, Client.Character, true)
end

Client.CharacterAdded:Connect(OnCharacterAdded)

--//ping handler (rejoin if ping is high)
--CONSTANTS
local MAX_PING = 1000 --The ping we flag
local MAX_FLAGS = 1 --amount of flags before we rejoin
local FLAG_COOLDOWN = 3 --cooldown between flags

--Variables
local Flags = 0
local LastFlag = os.clock()
local DataPingObject = game:GetService("Stats"):WaitForChild("Network"):WaitForChild("ServerStatsItem")["Data Ping"]

--Main
if not Client.Character then Client.CharacterAdded:Wait() end
local FirstStart = os.clock()

local Connection; Connection = game:GetService("RunService").RenderStepped:Connect(function()
    if os.clock() - FirstStart <= 5 then return end --dont check anything if we executed less than 5 seconds ago(we could get high ping at start)
    if os.clock() - LastFlag < FLAG_COOLDOWN then return end --if the last time we flagged was less than 3 seconds then dont do anything
    
    if DataPingObject:GetValue() > MAX_PING then --checking for ping fluctuations
        Flags = Flags + 1
        LastFlag = os.clock()
        print("FLAGGED!!!")
    end
    
    if Flags >= MAX_FLAGS then
        Connection:Disconnect()
        game:GetService("TeleportService"):Teleport(11637068797)
        print("Rejoining...")
    end
end)
